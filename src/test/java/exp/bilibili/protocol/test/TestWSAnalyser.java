package exp.bilibili.protocol.test;

import exp.libs.utils.num.BODHUtils;
import exp.libs.utils.other.StrUtils;

/**
 * <PRE>
 * 测试WebSocket的接收报文
 * </PRE>
 * <br/><B>PROJECT : </B> bilibili-plugin
 * <br/><B>SUPPORT : </B> <a href="http://www.exp-blog.com" target="_blank">www.exp-blog.com</a> 
 * @version   2017-12-17
 * @author    EXP: 272629724@qq.com
 * @since     jdk版本：jdk1.6
 */
public class TestWSAnalyser {

	public static void main(String[] args) {
		String hex = "000005F50010000000000005000000007B22636D64223A224E4F544943455F4D5347222C2266756C6C223A7B22686561645F69636F6E223A2268747470733A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F6C6976655C2F636166393366323463623834656533336239376539613932333938313937666539333535336330382E77656270222C227461696C5F69636F6E223A22687474703A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F6C6976655C2F383232646134383166646162613938366437333864623564386664343639666661393561386661312E77656270222C22686561645F69636F6E5F6661223A2268747470733A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F6C6976655C2F333933373833316462353734646438656237303362326562623639613866366161383735326439622E706E67222C227461696C5F69636F6E5F6661223A22687474703A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F6C6976655C2F333863623261396631323039623136633066313531363262306235353365336232386439663136662E706E67222C22686561645F69636F6E5F66616E223A32332C227461696C5F69636F6E5F66616E223A342C226261636B67726F756E64223A22233636413734454646222C22636F6C6F72223A22234646464646464646222C22686967686C69676874223A22234644464632464646222C2274696D65223A32307D2C2268616C66223A7B22686561645F69636F6E223A2268747470733A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F6C6976655C2F656339623337346361656335626438343839386633373830613130313839626539366238366434652E706E67222C227461696C5F69636F6E223A22222C226261636B67726F756E64223A22233835423937314646222C22636F6C6F72223A22234646464646464646222C22686967686C69676874223A22234644464632464646222C2274696D65223A31357D2C2273696465223A7B22686561645F69636F6E223A2268747470733A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F6C6976655C2F306264313336646263626631363433663263623532613666343237393765386238613062643634652E706E67222C226261636B67726F756E64223A22234634464445384646222C22636F6C6F72223A22233739423438454646222C22686967686C69676874223A22233338383732364646222C22626F72646572223A22234139444139464646227D2C22726F6F6D6964223A3238303138372C227265616C5F726F6F6D6964223A3238303138372C226D73675F636F6D6D6F6E223A225C75353136385C75353333615C75356537665C75363461645C75666631613C255C75363765305C75366161635C75376362655C75366339305C7536633930253E5C75363239355C75353538323C255C75393665385C75363566365C75363637345C7535393239253E335C75346532615C75356330665C75373533355C75383963365C75393864655C75383233395C75666630635C75373062395C75353166625C75353234645C753566383054415C75373638345C75363233665C75393566345C75353362625C75363262645C75353935365C7535343237222C226D73675F73656C66223A225C75353136385C75353333615C75356537665C75363461645C75666631613C255C75363765305C75366161635C75376362655C75366339305C7536633930253E5C75363239355C75353538323C255C75393665385C75363566365C75363637345C7535393239253E335C75346532615C75356330665C75373533355C75383963365C75393864655C75383233395C75666630635C75356665625C75363736355C75363262645C75353935365C7535343237222C226C696E6B5F75726C223A22687474703A5C2F5C2F6C6976652E62696C6962696C692E636F6D5C2F3238303138373F6C6976655F6C6F74746572795F747970653D312662726F6164636173745F747970653D30222C226D73675F74797065223A322C22736869656C645F756964223A2D312C22627573696E6573735F6964223A223235227D";
		alalyseMsg(hex);
	}
	
	private static void alalyseMsg(String hexMsg) {
		byte[] bytes = BODHUtils.toBytes(hexMsg);
		String msg = new String(bytes);
		System.out.println(StrUtils.view(msg));
		System.out.println("====");
		
		int len = 0;
		do {
			len = getLen(hexMsg);
			if(len <= 32) {
				break;
			}
			String subHexMsg = hexMsg.substring(32, len);
			msg = new String(BODHUtils.toBytes(subHexMsg));
			System.out.println(StrUtils.view(msg));
			
			
			hexMsg = hexMsg.substring(len);
		} while(StrUtils.isNotEmpty(hexMsg));
	}
	
	private static int getLen(String hexMsg) {
		String hexLen = hexMsg.substring(0, 8);	// 消息的前8位是本条消息长度
		long len = BODHUtils.hexToDec(hexLen);
		return (int) (len * 2);
	}
	
}
