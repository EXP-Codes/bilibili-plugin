package exp.bilibili.protocol.test;

import exp.libs.utils.num.BODHUtils;
import exp.libs.utils.other.StrUtils;

/**
 * <PRE>
 * 测试WebSocket的接收报文
 * </PRE>
 * <br/><B>PROJECT : </B> bilibili-plugin
 * <br/><B>SUPPORT : </B> <a href="http://www.exp-blog.com" target="_blank">www.exp-blog.com</a> 
 * @version   2017-12-17
 * @author    EXP: 272629724@qq.com
 * @since     jdk版本：jdk1.6
 */
public class TestWSAnalyser {

	public static void main(String[] args) {
		String hex = "000000F90010000000000005000000007B22696E666F223A5B5B302C312C32352C31363737373231352C313533353830343536382C313636353938343838372C302C223963663237616538222C302C305D2C22E4BB8AE5A4A9E4B88AE8AFBEE4BA86E38082E38082E38082E5889AE694BEE5ADA6E38082E38082E38082222C5B3336343831373633332C22E689A7E68C9AE5B08FE5A790E5A790E59096222C302C302C302C2235303030222C312C22225D2C5B5D2C5B302C302C393836383935302C223E3530303030225D2C5B5D2C302C302C7B22756E616D655F636F6C6F72223A22227D5D2C22636D64223A2244414E4D555F4D5347227D000004F90010000000000005000000007B22636D64223A2253454E445F47494654222C2264617461223A7B22676966744E616D65223A225C75386661335C7536373631222C226E756D223A312C22756E616D65223A225C75353931635C75393665385C75353932395C7536386136222C2266616365223A22687474703A5C2F5C2F69322E6864736C622E636F6D5C2F6266735C2F666163655C2F316331633833303031313234336537636663623037613531343361636366333161333135383830372E6A7067222C2267756172645F6C6576656C223A302C2272636F7374223A34373632323135392C22756964223A36383031383731372C22746F705F6C697374223A5B7B22756964223A31343038333330382C22756E616D65223A225C75376638615C75396137635C7535636238222C2266616365223A22687474703A5C2F5C2F69312E6864736C622E636F6D5C2F6266735C2F666163655C2F313762393538313139633161646633353334373132663536313636313838393437303135343435612E6A7067222C2272616E6B223A312C2273636F7265223A323634343830302C2267756172645F6C6576656C223A322C22697353656C66223A307D2C7B22756964223A373230343431322C22756E616D65223A225C75356330665C75356334655C75346533385C75346533385C7534653338222C2266616365223A22687474703A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F666163655C2F373334663038346330616133303336396636393731613235633065326133303835316465353965362E6A7067222C2272616E6B223A322C2273636F7265223A323437393830302C2267756172645F6C6576656C223A322C22697353656C66223A307D2C7B22756964223A3238303531323138372C22756E616D65223A225C75383433645C75383433645C75373637645C7537363764222C2266616365223A22687474703A5C2F5C2F69322E6864736C622E636F6D5C2F6266735C2F666163655C2F656238353261343361633932356230643435646166663464386333373838633430316463386333342E6A7067222C2272616E6B223A332C2273636F7265223A323434313030302C2267756172645F6C6576656C223A332C22697353656C66223A307D5D2C2274696D657374616D70223A313533353830343536372C22676966744964223A312C226769667454797065223A302C22616374696F6E223A225C75353538325C7539386466222C227375706572223A302C2273757065725F676966745F6E756D223A302C227072696365223A3130302C22726E64223A2231373332323831323236222C226E65774D6564616C223A302C226E65775469746C65223A302C226D6564616C223A5B5D2C227469746C65223A22222C22626561744964223A22222C2262697A5F736F75726365223A226C697665222C226D65746164617461223A22222C2272656D61696E223A302C22676F6C64223A302C2273696C766572223A302C226576656E7453636F7265223A302C226576656E744E756D223A302C22736D616C6C74765F6D7367223A5B5D2C227370656369616C47696674223A6E756C6C2C226E6F746963655F6D7367223A5B5D2C2263617073756C65223A6E756C6C2C22616464466F6C6C6F77223A302C226566666563745F626C6F636B223A312C22636F696E5F74797065223A2273696C766572222C22746F74616C5F636F696E223A3130302C227461675F696D616765223A22227D7D";
		alalyseMsg(hex);
	}
	
	private static void alalyseMsg(String hexMsg) {
		byte[] bytes = BODHUtils.toBytes(hexMsg);
		String msg = new String(bytes);
		System.out.println(StrUtils.view(msg));
		System.out.println("====");
		
		int len = 0;
		do {
			len = getLen(hexMsg);
			if(len <= 32) {
				break;
			}
			String subHexMsg = hexMsg.substring(32, len);
			msg = new String(BODHUtils.toBytes(subHexMsg));
			System.out.println(StrUtils.view(msg));
			
			
			hexMsg = hexMsg.substring(len);
		} while(StrUtils.isNotEmpty(hexMsg));
	}
	
	private static int getLen(String hexMsg) {
		String hexLen = hexMsg.substring(0, 8);	// 消息的前8位是本条消息长度
		long len = BODHUtils.hexToDec(hexLen);
		return (int) (len * 2);
	}
	
}
