package exp.bilibili.protocol.test;

import exp.libs.utils.num.BODHUtils;
import exp.libs.utils.other.StrUtils;

/**
 * <PRE>
 * 测试WebSocket的接收报文
 * </PRE>
 * <br/><B>PROJECT : </B> bilibili-plugin
 * <br/><B>SUPPORT : </B> <a href="http://www.exp-blog.com" target="_blank">www.exp-blog.com</a> 
 * @version   2017-12-17
 * @author    EXP: 272629724@qq.com
 * @since     jdk版本：jdk1.6
 */
public class TestWSAnalyser {

	public static void main(String[] args) {
		String hex = "000005CC0010000000000005000000007B22636D64223A224E4F544943455F4D5347222C2266756C6C223A7B22686561645F69636F6E223A22687474703A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F6C6976655C2F643633653738616465323331393130383339306231643661353961383162326162653436393235642E706E67222C227461696C5F69636F6E223A22687474703A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F6C6976655C2F383232646134383166646162613938366437333864623564386664343639666661393561386661312E77656270222C22686561645F69636F6E5F6661223A22687474703A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F6C6976655C2F643633653738616465323331393130383339306231643661353961383162326162653436393235642E706E67222C227461696C5F69636F6E5F6661223A22687474703A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F6C6976655C2F333863623261396631323039623136633066313531363262306235353365336232386439663136662E706E67222C22686561645F69636F6E5F66616E223A312C227461696C5F69636F6E5F66616E223A342C226261636B67726F756E64223A22234646423033434646222C22636F6C6F72223A22234646464646464646222C22686967686C69676874223A22234232354143314646222C2274696D65223A31307D2C2268616C66223A7B22686561645F69636F6E223A22222C227461696C5F69636F6E223A22222C226261636B67726F756E64223A22222C22636F6C6F72223A22222C22686967686C69676874223A22222C2274696D65223A387D2C2273696465223A7B22686561645F69636F6E223A22687474703A5C2F5C2F69302E6864736C622E636F6D5C2F6266735C2F6C6976655C2F313763353335333134303034353334356633316337343735343332393230646630383335313833372E706E67222C226261636B67726F756E64223A22234646453943384646222C22636F6C6F72223A22234546393033414646222C22686967686C69676874223A22234435343930304646222C22626F72646572223A22234646434641344646227D2C22726F6F6D6964223A3238382C227265616C5F726F6F6D6964223A3532313432392C226D73675F636F6D6D6F6E223A223C255C75356330665C75393163655C75356262365C75373638345C75353337375C75353337375C75353337375C75386662395C75363261625C7538343238253E205C7535373238203C255C75356330665C75393163655C75353962395C753562353077253E205C75373638345C75363233665C75393566345C75356630305C75393031615C75346538365C75363033625C75373736335C75356537365C75383965365C75353364315C75346538365C75363262645C75353935365C75666630635C75373062395C75353166625C75353234645C753566383054415C75373638345C75363233665C75393566345C75353362625C75363262645C75353935365C7535343237222C226D73675F73656C66223A223C255C75356330665C75393163655C75356262365C75373638345C75353337375C75353337375C75353337375C75386662395C75363261625C7538343238253E205C75353732385C75363732635C75363233665C75393566345C75356630305C75393031615C75346538365C75363033625C75373736335C75356537365C75383965365C75353364315C75346538365C75363262645C75353935365C75666630635C75356665625C75363736355C75363262645C75353935365C7535343237222C226C696E6B5F75726C223A2268747470733A5C2F5C2F6C6976652E62696C6962696C692E636F6D5C2F3532313432393F6C6976655F6C6F74746572795F747970653D322662726F6164636173745F747970653D302666726F6D3D32383030332665787472615F6A756D705F66726F6D3D3238303033222C226D73675F74797065223A332C22736869656C645F756964223A2D317D";
		alalyseMsg(hex);
	}
	
	private static void alalyseMsg(String hexMsg) {
		byte[] bytes = BODHUtils.toBytes(hexMsg);
		String msg = new String(bytes);
		System.out.println(StrUtils.view(msg));
		System.out.println("====");
		
		int len = 0;
		do {
			len = getLen(hexMsg);
			if(len <= 32) {
				break;
			}
			String subHexMsg = hexMsg.substring(32, len);
			msg = new String(BODHUtils.toBytes(subHexMsg));
			System.out.println(StrUtils.view(msg));
			
			
			hexMsg = hexMsg.substring(len);
		} while(StrUtils.isNotEmpty(hexMsg));
	}
	
	private static int getLen(String hexMsg) {
		String hexLen = hexMsg.substring(0, 8);	// 消息的前8位是本条消息长度
		long len = BODHUtils.hexToDec(hexLen);
		return (int) (len * 2);
	}
	
}
